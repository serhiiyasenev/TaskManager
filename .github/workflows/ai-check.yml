name: ğŸ” Validate AI Integration (ACE-FCA)

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-ai-structure:
    name: ğŸ§  Validate AI context files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Check required files
        run: |
          echo "Checking for required AI files..."
          test -f "AI/AGENTS.md" && echo "âœ… AGENTS.md found" || (echo "âŒ Missing AI/AGENTS.md" && exit 1)
          test -f "AI/research.md" && echo "âœ… research.md found" || (echo "âŒ Missing AI/research.md" && exit 1)
          test -f "AI/plan.md" && echo "âœ… plan.md found" || (echo "âŒ Missing AI/plan.md" && exit 1)
          test -f "AI/decisions.md" && echo "âœ… decisions.md found" || (echo "âŒ Missing AI/decisions.md" && exit 1)
          test -f "AI/AI_GUIDE.md" && echo "âœ… AI_GUIDE.md found" || (echo "âŒ Missing AI/AI_GUIDE.md" && exit 1)
          test -d "AI/traces" && echo "âœ… traces/ directory exists" || (echo "âŒ Missing AI/traces directory" && exit 1)

      - name: ğŸ“‹ Validate YAML preamble in AI_GUIDE.md
        run: |
          echo "Checking YAML preamble validity..."
          head -n 15 AI/AI_GUIDE.md | grep -q "ai_integration:" || (echo "âŒ Missing YAML preamble in AI_GUIDE.md" && exit 1)
          head -n 15 AI/AI_GUIDE.md | grep -q "context_files:" || (echo "âŒ Missing context_files section" && exit 1)
          head -n 15 AI/AI_GUIDE.md | grep -q "reset_policy:" || (echo "âŒ Missing reset_policy section" && exit 1)
          echo "âœ… YAML preamble detected and valid"

      - name: ğŸ§¾ Validate plan.md content
        run: |
          echo "Checking plan.md structure..."
          grep -q "## GOAL" AI/plan.md || (echo "âŒ plan.md is missing GOAL section" && exit 1)
          grep -q "|" AI/plan.md || (echo "âŒ plan.md appears to be missing step table" && exit 1)
          echo "âœ… plan.md structure is valid"

      - name: â±ï¸ Validate recent trace file
        run: |
          echo "Checking trace timestamps..."
          latest_trace=$(find AI/traces -type f -name "*.md" -printf "%T@ %p\n" | sort -n | tail -1 | cut -d' ' -f2-)
          if [ -z "$latest_trace" ]; then
            echo "âŒ No trace files found in AI/traces/"
            exit 1
          fi
          echo "Most recent trace: $latest_trace"
          file_age_days=$(( ( $(date +%s) - $(stat -c %Y "$latest_trace") ) / 86400 ))
          if [ "$file_age_days" -gt 7 ]; then
            echo "âš ï¸ Warning: last trace file is older than 7 days ($file_age_days days)"
          else
            echo "âœ… Recent trace file updated within 7 days"
          fi

      - name: ğŸ§© Summary
        run: echo "âœ… All AI integration checks passed successfully!"
